# 青云平台 - 快速部署指南

## 🚀 一键部署（推荐）

### 1. 上传项目到服务器

```bash
# 在服务器上创建项目目录
sudo mkdir -p /opt/qingyun-platform
cd /opt/qingyun-platform

# 方式1: 使用Git克隆
git clone <your-repo-url> .

# 方式2: 使用SCP上传（从本地）
scp -r ./qingyun-platform/* root@139.199.225.54:/opt/qingyun-platform/
```

### 2. 配置环境变量

```bash
cd /opt/qingyun-platform

# 创建.env文件（可选，使用默认值）
cat > .env << EOF
MYSQL_ROOT_PASSWORD=qingyun123456
MYSQL_DATABASE=qingyun_db
MYSQL_USER=qingyun
MYSQL_PASSWORD=qingyun123456
GATEWAY_PORT=8080
NACOS_PORT=8848
EOF
```

### 3. 执行部署脚本

```bash
# 赋予执行权限
chmod +x deploy.sh

# 启动所有服务
./deploy.sh start

# 查看服务状态
./deploy.sh status

# 查看日志
./deploy.sh logs
```

## 📋 手动部署步骤

如果不想使用脚本，可以手动执行以下步骤：

### 1. 安装Docker和Docker Compose

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Docker
sudo apt install -y docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
docker-compose --version
```

### 2. 创建目录结构

```bash
cd /opt/qingyun-platform
mkdir -p data/{mysql,redis,nacos/{logs,data}}
mkdir -p logs/{gateway,auth,user-service,question-service,record-service,admin-service,stat-service,web-admin,web-user}
mkdir -p config/{mysql,redis}
```

### 3. 构建和启动

```bash
# 构建所有镜像（首次需要较长时间）
docker-compose build

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 初始化Nacos数据库

Nacos需要单独的数据库，执行以下SQL：

```sql
CREATE DATABASE IF NOT EXISTS nacos_config CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE nacos_config;

-- 执行Nacos的SQL脚本（从Nacos官方获取）
-- 或者让Nacos容器自动初始化（首次启动会自动创建表）
```

### 5. 配置Nacos

1. 访问 http://139.199.225.54:8848/nacos
2. 默认账号：`nacos` / `nacos`
3. 创建命名空间：`qingyun-dev`
4. 创建公共配置：`qingyun-common.yml`

## 🔍 验证部署

### 检查服务状态

```bash
# 查看所有容器状态
docker-compose ps

# 查看资源使用
docker stats

# 检查端口监听
netstat -tunlp | grep -E '8080|8848|3306|6379'
```

### 测试服务

```bash
# 测试网关
curl http://localhost:8080/actuator/health

# 测试Nacos
curl http://localhost:8848/nacos/actuator/health

# 查看服务注册情况（需要先登录Nacos）
curl http://localhost:8848/nacos/v1/ns/service/list
```

## 🔧 常用操作

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f gateway
docker-compose logs -f auth
docker-compose logs -f user-service
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart gateway
```

### 更新服务

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker-compose up -d --build

# 或者使用部署脚本
./deploy.sh update
```

### 停止服务

```bash
# 停止所有服务
docker-compose down

# 停止并删除数据卷（谨慎操作）
docker-compose down -v
```

## 🔒 安全配置

### 1. 防火墙设置

```bash
# 开放必要端口
sudo ufw allow 8080/tcp    # Gateway
sudo ufw allow 8848/tcp    # Nacos
sudo ufw allow 22/tcp      # SSH

# 启用防火墙
sudo ufw enable

# 查看防火墙状态
sudo ufw status
```

### 2. 修改默认密码

```bash
# 修改.env文件中的密码
nano .env

# 修改MySQL root密码
MYSQL_ROOT_PASSWORD=your_strong_password

# 修改Nacos密码（在Nacos控制台修改）
```

### 3. 限制数据库访问

MySQL和Redis已配置为仅内网访问（127.0.0.1），确保安全。

## 📊 监控和维护

### 查看资源使用

```bash
# 实时监控
docker stats

# 查看磁盘使用
df -h
du -sh /opt/qingyun-platform/data/*

# 查看容器日志大小
docker-compose logs --no-log-prefix | wc -l
```

### 备份数据

```bash
# 使用部署脚本备份
./deploy.sh backup

# 或手动备份
docker exec qingyun-mysql mysqldump -uroot -pqingyun123456 qingyun_db > backup.sql
```

### 清理日志

```bash
# 清理7天前的日志
find /opt/qingyun-platform/logs -name "*.log" -mtime +7 -delete

# 清理Docker日志
docker system prune -f
```

## 🐛 故障排查

### 服务无法启动

1. 检查日志：`docker-compose logs [service-name]`
2. 检查端口占用：`netstat -tunlp | grep [port]`
3. 检查Docker网络：`docker network inspect qingyun-network`
4. 检查资源：`docker stats`

### 数据库连接失败

1. 检查MySQL容器：`docker-compose ps mysql`
2. 查看MySQL日志：`docker-compose logs mysql`
3. 测试连接：`docker exec -it qingyun-mysql mysql -uroot -p`

### Nacos连接失败

1. 检查Nacos容器：`docker-compose ps nacos`
2. 查看Nacos日志：`docker-compose logs nacos`
3. 检查Nacos健康：`curl http://localhost:8848/nacos/actuator/health`

## 📝 注意事项

1. **端口隔离**: 所有微服务端口（8000-9002）仅内网访问，不对外开放
2. **数据持久化**: 数据存储在 `/opt/qingyun-platform/data` 目录
3. **日志管理**: 定期清理日志，避免磁盘空间不足
4. **备份策略**: 建议每天备份数据库
5. **资源监控**: 定期检查服务器资源使用情况

## 🌐 访问地址

部署完成后，可以通过以下地址访问：

- **API网关**: http://139.199.225.54:8080
- **Nacos控制台**: http://139.199.225.54:8848/nacos
- **API文档**: http://139.199.225.54:8080/doc.html

---

**提示**: 首次部署需要下载镜像和构建项目，可能需要10-30分钟，请耐心等待。

