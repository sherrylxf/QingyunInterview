# é’äº‘å¹³å° - äº‘æœåŠ¡å™¨éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ éƒ¨ç½²ç¯å¢ƒä¿¡æ¯

- **æœåŠ¡å™¨IP**: 139.199.225.54ï¼ˆå…¬ç½‘ï¼‰ / 10.1.0.15ï¼ˆå†…ç½‘ï¼‰
- **æ“ä½œç³»ç»Ÿ**: Ubuntu
- **å·²å ç”¨ç«¯å£**: 80, 443, 5432ï¼ˆPostgreSQLï¼‰
- **éƒ¨ç½²æ–¹å¼**: Docker Composeï¼ˆå®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¾¿äºéš”ç¦»ï¼‰

## ğŸ¯ éƒ¨ç½²æ¶æ„

```
äº‘æœåŠ¡å™¨
â”œâ”€â”€ ç°æœ‰é¡¹ç›®ï¼ˆ80, 443, 5432ç«¯å£ï¼‰
â””â”€â”€ é’äº‘å¹³å°ï¼ˆç‹¬ç«‹Dockerç½‘ç»œï¼‰
    â”œâ”€â”€ Nacosï¼ˆ8848ç«¯å£ï¼‰
    â”œâ”€â”€ MySQLï¼ˆ3306ç«¯å£ï¼Œä»…å†…ç½‘ï¼‰
    â”œâ”€â”€ Redisï¼ˆ6379ç«¯å£ï¼Œä»…å†…ç½‘ï¼‰
    â”œâ”€â”€ Gatewayï¼ˆ8080ç«¯å£ï¼‰
    â”œâ”€â”€ Authï¼ˆ8000ç«¯å£ï¼‰
    â””â”€â”€ å„ä¸šåŠ¡æœåŠ¡ï¼ˆ8001-8005, 9001-9002ç«¯å£ï¼‰
```

## ğŸ“¦ ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
| ---- | ---- | ---- |
| Nacos | 8848 | æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒ |
| MySQL | 3306 | æ•°æ®åº“ï¼ˆä»…å†…ç½‘è®¿é—®ï¼‰ |
| Redis | 6379 | ç¼“å­˜ï¼ˆä»…å†…ç½‘è®¿é—®ï¼‰ |
| Gateway | 8080 | APIç½‘å…³ï¼ˆå¯¹å¤–æš´éœ²ï¼‰ |
| Auth | 8000 | è®¤è¯æœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| User Service | 8001 | ç”¨æˆ·æœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| Question Service | 8002 | é¢˜åº“æœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| Record Service | 8003 | æ‰“å¡è®°å½•æœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| Admin Service | 8004 | ç®¡ç†å‘˜æœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| Stat Service | 8005 | ç»Ÿè®¡åˆ†ææœåŠ¡ï¼ˆå†…ç½‘ï¼‰ |
| Web Admin | 9001 | ç®¡ç†ç«¯åç«¯ï¼ˆå†…ç½‘ï¼‰ |
| Web User | 9002 | ç”¨æˆ·ç«¯åç«¯ï¼ˆå†…ç½‘ï¼‰ |

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…Dockerå’ŒDocker Compose
sudo apt install -y docker.io docker-compose

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯Dockerå®‰è£…
docker --version
docker-compose --version
```

### 2. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®æ ¹ç›®å½•
sudo mkdir -p /opt/qingyun-platform
cd /opt/qingyun-platform

# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
sudo mkdir -p {logs,data/{mysql,redis,nacos},config}
```

### 3. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

å°†é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆå¯ä»¥ä½¿ç”¨git cloneæˆ–scpï¼‰ï¼š

```bash
# æ–¹å¼1: ä½¿ç”¨Git
cd /opt/qingyun-platform
git clone <your-repo-url> .

# æ–¹å¼2: ä½¿ç”¨SCPï¼ˆä»æœ¬åœ°ï¼‰
scp -r ./qingyun-platform root@139.199.225.54:/opt/
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /opt/qingyun-platform
sudo nano .env
```

å†…å®¹å¦‚ä¸‹ï¼š

```env
# æ•°æ®åº“é…ç½®
MYSQL_ROOT_PASSWORD=qingyun123456
MYSQL_DATABASE=qingyun_db
MYSQL_USER=qingyun
MYSQL_PASSWORD=qingyun123456

# Redisé…ç½®
REDIS_PASSWORD=

# Nacosé…ç½®
NACOS_SERVER=localhost:8848
NACOS_USERNAME=nacos
NACOS_PASSWORD=nacos

# æœåŠ¡ç«¯å£é…ç½®
GATEWAY_PORT=8080
AUTH_PORT=8000
USER_SERVICE_PORT=8001
QUESTION_SERVICE_PORT=8002
RECORD_SERVICE_PORT=8003
ADMIN_SERVICE_PORT=8004
STAT_SERVICE_PORT=8005
WEB_ADMIN_PORT=9001
WEB_USER_PORT=9002

# JVMå‚æ•°
JVM_OPTS=-Xms512m -Xmx1024m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
```

### 5. æ„å»ºå’Œå¯åŠ¨æœåŠ¡

```bash
# æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ
docker-compose build

# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 6. åˆå§‹åŒ–æ•°æ®åº“

ç­‰å¾…MySQLå¯åŠ¨åï¼Œæ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼š

```bash
# è¿›å…¥MySQLå®¹å™¨
docker exec -it qingyun-mysql mysql -uroot -pqingyun123456

# åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE DATABASE IF NOT EXISTS qingyun_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# é€€å‡ºMySQL
exit
```

### 7. é…ç½®Nacos

1. è®¿é—®Nacosæ§åˆ¶å°ï¼šhttp://139.199.225.54:8848/nacos
2. é»˜è®¤è´¦å·ï¼šnacos / nacos
3. åˆ›å»ºå‘½åç©ºé—´ï¼š`qingyun-dev`
4. åˆ›å»ºå…¬å…±é…ç½®ï¼š`qingyun-common.yml`

### 8. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose ps

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8080/actuator/health

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs gateway
docker-compose logs auth
```

## ğŸ”§ å¸¸ç”¨æ“ä½œå‘½ä»¤

### å¯åŠ¨/åœæ­¢æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart gateway

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs -f gateway

# è¿›å…¥å®¹å™¨
docker exec -it qingyun-gateway bash
```

### æ›´æ–°æœåŠ¡

```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æ›´æ–°ç‰¹å®šæœåŠ¡
docker-compose up -d --build gateway
```

### å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½MySQLæ•°æ®
docker exec qingyun-mysql mysqldump -uroot -pqingyun123456 qingyun_db > backup_$(date +%Y%m%d).sql

# å¤‡ä»½Redisæ•°æ®
docker exec qingyun-redis redis-cli SAVE
docker cp qingyun-redis:/data/dump.rdb ./backup_redis_$(date +%Y%m%d).rdb
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# å¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 8080/tcp    # Gateway
sudo ufw allow 8848/tcp    # Nacos
sudo ufw allow 22/tcp      # SSH

# ä¸å¼€æ”¾å†…ç½‘æœåŠ¡ç«¯å£ï¼ˆ8000-9002ï¼‰
# è¿™äº›æœåŠ¡åªé€šè¿‡Gatewayè®¿é—®
```

### 2. Nginxåå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦é€šè¿‡80/443ç«¯å£è®¿é—®ï¼Œå¯ä»¥é…ç½®Nginxåå‘ä»£ç†ï¼š

```nginx
server {
    listen 80;
    server_name qingyun.yourdomain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 3. æ•°æ®åº“å®‰å…¨

- MySQLä»…å…è®¸å†…ç½‘è®¿é—®ï¼ˆDockerç½‘ç»œï¼‰
- Redisä»…å…è®¸å†…ç½‘è®¿é—®ï¼ˆDockerç½‘ç»œï¼‰
- ä½¿ç”¨å¼ºå¯†ç 
- å®šæœŸå¤‡ä»½æ•°æ®

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h
du -sh /opt/qingyun-platform/data/*
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs --tail=100

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f gateway

# æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
find /opt/qingyun-platform/logs -name "*.log" -mtime +7 -delete
```

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs [service-name]

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tunlp | grep [port]

# æ£€æŸ¥Dockerç½‘ç»œ
docker network ls
docker network inspect qingyun-network
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥MySQLå®¹å™¨çŠ¶æ€
docker-compose ps mysql

# æŸ¥çœ‹MySQLæ—¥å¿—
docker-compose logs mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec -it qingyun-mysql mysql -uroot -pqingyun123456 -e "SHOW DATABASES;"
```

### Nacosè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥Nacoså®¹å™¨çŠ¶æ€
docker-compose ps nacos

# æŸ¥çœ‹Nacosæ—¥å¿—
docker-compose logs nacos

# æ£€æŸ¥Nacoså¥åº·çŠ¶æ€
curl http://localhost:8848/nacos/actuator/health
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç«¯å£éš”ç¦»**: æ‰€æœ‰å¾®æœåŠ¡ç«¯å£ï¼ˆ8000-9002ï¼‰ä»…åœ¨å†…ç½‘è®¿é—®ï¼Œä¸å¯¹å¤–å¼€æ”¾
2. **æ•°æ®æŒä¹…åŒ–**: é‡è¦æ•°æ®å­˜å‚¨åœ¨ `/opt/qingyun-platform/data` ç›®å½•
3. **æ—¥å¿—ç®¡ç†**: å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…ç£ç›˜ç©ºé—´ä¸è¶³
4. **å¤‡ä»½ç­–ç•¥**: å»ºè®®æ¯å¤©å¤‡ä»½æ•°æ®åº“ï¼Œæ¯å‘¨å¤‡ä»½å®Œæ•´æ•°æ®ç›®å½•
5. **èµ„æºç›‘æ§**: å®šæœŸæ£€æŸ¥æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶æ‰©å®¹

## ğŸ”„ æ›´æ–°éƒ¨ç½²

å½“ä»£ç æ›´æ–°åï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ›´æ–°éƒ¨ç½²ï¼š

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /opt/qingyun-platform
git pull

# 2. é‡æ–°æ„å»ºé•œåƒ
docker-compose build

# 3. æ»šåŠ¨æ›´æ–°æœåŠ¡ï¼ˆå…ˆæ›´æ–°åç«¯æœåŠ¡ï¼Œæœ€åæ›´æ–°ç½‘å…³ï¼‰
docker-compose up -d --no-deps user-service
docker-compose up -d --no-deps question-service
# ... å…¶ä»–æœåŠ¡
docker-compose up -d --no-deps gateway

# 4. éªŒè¯æœåŠ¡
docker-compose ps
curl http://localhost:8080/actuator/health
```

---

**éƒ¨ç½²å®Œæˆåè®¿é—®åœ°å€**:
- APIç½‘å…³: http://139.199.225.54:8080
- Nacosæ§åˆ¶å°: http://139.199.225.54:8848/nacos
- APIæ–‡æ¡£: http://139.199.225.54:8080/doc.html

