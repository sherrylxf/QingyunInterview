# é‡æ–°éƒ¨ç½²æŒ‡å—

## ðŸ—‘ï¸ åˆ é™¤çŽ°æœ‰éƒ¨ç½²

### 1. åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨

```bash
cd /opt/qingyun-platform

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# å¦‚æžœä¸Šé¢å‘½ä»¤å¤±è´¥ï¼Œå¼ºåˆ¶åˆ é™¤
docker-compose down -v --remove-orphans

# ç¡®è®¤æ‰€æœ‰å®¹å™¨å·²åœæ­¢
docker ps -a | grep qingyun
```

### 2. åˆ é™¤é¡¹ç›®ç›®å½•

```bash
# å¤‡ä»½é‡è¦æ•°æ®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
sudo tar -czf /tmp/qingyun-backup-$(date +%Y%m%d).tar.gz /opt/qingyun-platform/data

# åˆ é™¤æ•´ä¸ªé¡¹ç›®ç›®å½•
sudo rm -rf /opt/qingyun-platform

# ç¡®è®¤åˆ é™¤æˆåŠŸ
ls -la /opt/ | grep qingyun
```

### 3. æ¸…ç†Dockerèµ„æºï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# åˆ é™¤æœªä½¿ç”¨çš„ç½‘ç»œ
docker network prune

# æŸ¥çœ‹å‰©ä½™èµ„æº
docker images | grep qingyun
docker network ls | grep qingyun
```

## ðŸš€ é‡æ–°éƒ¨ç½²

### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®æ ¹ç›®å½•
sudo mkdir -p /opt/qingyun-platform
cd /opt/qingyun-platform

# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æž„
sudo mkdir -p logs/{gateway,auth,user-service,question-service,record-service,admin-service,stat-service,web-admin,web-user}
sudo mkdir -p data/{mysql,redis,nacos/{logs,data}}
sudo mkdir -p config/{mysql,redis}
```

### 2. å…‹éš†é¡¹ç›®

```bash
cd /opt/qingyun-platform

# å…‹éš†é¡¹ç›®
git clone https://github.com/sherrylxf/QingyunInterview.git .

# æˆ–è€…å¦‚æžœå·²ç»åœ¨å­ç›®å½•ï¼Œç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
# mv QingyunInterview/* .
# mv QingyunInterview/.* . 2>/dev/null || true
# rmdir QingyunInterview
```

### 3. åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
cd /opt/qingyun-platform

# åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
# æ•°æ®åº“é…ç½®
MYSQL_ROOT_PASSWORD=123456
MYSQL_DATABASE=qingyun_db
MYSQL_USER=qingyun
MYSQL_PASSWORD=123456

# Redisé…ç½®
REDIS_PASSWORD=123456

# Nacosé…ç½®
NACOS_SERVER=localhost:8848
NACOS_USERNAME=nacos
NACOS_PASSWORD=123456

# æœåŠ¡ç«¯å£é…ç½®
GATEWAY_PORT=8080
AUTH_PORT=8000
USER_SERVICE_PORT=8001
QUESTION_SERVICE_PORT=8002
RECORD_SERVICE_PORT=8003
ADMIN_SERVICE_PORT=8004
STAT_SERVICE_PORT=8005
WEB_ADMIN_PORT=9001
WEB_USER_PORT=9002

# JVMå‚æ•°
JVM_OPTS=-Xms512m -Xmx1024m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
EOF

# éªŒè¯ .env æ–‡ä»¶
cat .env
```

### 4. åˆ›å»ºMySQLå’ŒRedisé…ç½®æ–‡ä»¶

```bash
cd /opt/qingyun-platform

# åˆ›å»ºMySQLé…ç½®ç›®å½•å’Œæ–‡ä»¶
mkdir -p config/mysql
cat > config/mysql/my.cnf << 'EOF'
[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
default-time-zone='+8:00'
general_log=0
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2
max_connections=200
max_connect_errors=10
innodb_buffer_pool_size=256M
innodb_log_file_size=128M
innodb_flush_log_at_trx_commit=2

[client]
default-character-set=utf8mb4
EOF

# åˆ›å»ºRedisé…ç½®ç›®å½•å’Œæ–‡ä»¶
mkdir -p config/redis
cat > config/redis/redis.conf << 'EOF'
port 6379
bind 0.0.0.0
protected-mode no
daemonize no
save 900 1
save 300 10
save 60 10000
loglevel notice
logfile ""
dir /data
maxmemory 512mb
maxmemory-policy allkeys-lru
appendonly yes
appendfsync everysec
EOF
```

### 5. æž„å»ºå’Œå¯åŠ¨

```bash
cd /opt/qingyun-platform

# æž„å»ºæ‰€æœ‰é•œåƒï¼ˆé¦–æ¬¡éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œ10-30åˆ†é’Ÿï¼‰
docker-compose build

# å¦‚æžœæž„å»ºæˆåŠŸï¼Œå¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—ï¼ˆç­‰å¾…æœåŠ¡å¯åŠ¨ï¼‰
docker-compose logs -f
```

### 6. åˆå§‹åŒ–æ•°æ®åº“

```bash
# ç­‰å¾…MySQLå¯åŠ¨ï¼ˆçº¦30ç§’ï¼‰
sleep 30

# è¿›å…¥MySQLå®¹å™¨åˆ›å»ºæ•°æ®åº“
docker exec -it qingyun-mysql mysql -uroot -p123456 -e "CREATE DATABASE IF NOT EXISTS qingyun_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# éªŒè¯æ•°æ®åº“åˆ›å»ºæˆåŠŸ
docker exec -it qingyun-mysql mysql -uroot -p123456 -e "SHOW DATABASES;"
```

### 7. é…ç½®Nacos

1. è®¿é—® Nacos æŽ§åˆ¶å°ï¼šhttp://139.199.225.54:8848/nacos
2. é»˜è®¤è´¦å·ï¼š`nacos` / `nacos`
3. åˆ›å»ºå‘½åç©ºé—´ï¼š`qingyun-dev`
4. åˆ›å»ºå…¬å…±é…ç½®ï¼š`qingyun-common.yml`ï¼ˆå¦‚æžœéœ€è¦ï¼‰

### 8. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose ps

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8080/actuator/health 2>/dev/null || echo "Gatewayæœªå°±ç»ª"
curl http://localhost:8848/nacos/ 2>/dev/null || echo "Nacosæœªå°±ç»ª"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs --tail=50 gateway
docker-compose logs --tail=50 auth
```

## ðŸ“‹ ä¸€é”®è„šæœ¬

ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸€é”®è„šæœ¬ï¼š

```bash
#!/bin/bash
# é‡æ–°éƒ¨ç½²è„šæœ¬

set -e

PROJECT_DIR="/opt/qingyun-platform"

echo "=== åœæ­¢çŽ°æœ‰æœåŠ¡ ==="
cd $PROJECT_DIR 2>/dev/null && docker-compose down -v || echo "ç›®å½•ä¸å­˜åœ¨æˆ–æœåŠ¡æœªè¿è¡Œ"

echo "=== åˆ é™¤é¡¹ç›®ç›®å½• ==="
sudo rm -rf $PROJECT_DIR

echo "=== åˆ›å»ºé¡¹ç›®ç›®å½• ==="
sudo mkdir -p $PROJECT_DIR
cd $PROJECT_DIR

echo "=== å…‹éš†é¡¹ç›® ==="
git clone https://github.com/sherrylxf/QingyunInterview.git .

echo "=== åˆ›å»ºç›®å½•ç»“æž„ ==="
sudo mkdir -p logs/{gateway,auth,user-service,question-service,record-service,admin-service,stat-service,web-admin,web-user}
sudo mkdir -p data/{mysql,redis,nacos/{logs,data}}
sudo mkdir -p config/{mysql,redis}

echo "=== åˆ›å»ºé…ç½®æ–‡ä»¶ ==="
# åˆ›å»º .env æ–‡ä»¶ï¼ˆä½¿ç”¨ä¸Šé¢çš„å†…å®¹ï¼‰
cat > .env << 'EOF'
MYSQL_ROOT_PASSWORD=123456
MYSQL_DATABASE=qingyun_db
MYSQL_USER=qingyun
MYSQL_PASSWORD=123456
REDIS_PASSWORD=123456
NACOS_SERVER=localhost:8848
NACOS_USERNAME=nacos
NACOS_PASSWORD=123456
GATEWAY_PORT=8080
AUTH_PORT=8000
USER_SERVICE_PORT=8001
QUESTION_SERVICE_PORT=8002
RECORD_SERVICE_PORT=8003
ADMIN_SERVICE_PORT=8004
STAT_SERVICE_PORT=8005
WEB_ADMIN_PORT=9001
WEB_USER_PORT=9002
JVM_OPTS=-Xms512m -Xmx1024m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m
EOF

echo "=== æž„å»ºé•œåƒ ==="
docker-compose build

echo "=== å¯åŠ¨æœåŠ¡ ==="
docker-compose up -d

echo "=== ç­‰å¾…æœåŠ¡å¯åŠ¨ ==="
sleep 30

echo "=== åˆå§‹åŒ–æ•°æ®åº“ ==="
docker exec -it qingyun-mysql mysql -uroot -p123456 -e "CREATE DATABASE IF NOT EXISTS qingyun_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || echo "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ"

echo "=== éƒ¨ç½²å®Œæˆ ==="
echo "è®¿é—®åœ°å€ï¼š"
echo "  - APIç½‘å…³: http://139.199.225.54:8080"
echo "  - NacosæŽ§åˆ¶å°: http://139.199.225.54:8848/nacos"
echo ""
echo "æŸ¥çœ‹æœåŠ¡çŠ¶æ€: docker-compose ps"
echo "æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šåˆ é™¤å‰è¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®
2. **ç«¯å£å ç”¨**ï¼šç¡®ä¿ç«¯å£ 8080ã€8848 ç­‰æœªè¢«å ç”¨
3. **ç£ç›˜ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘5GBï¼‰
4. **ç½‘ç»œè¿žæŽ¥**ï¼šæž„å»ºè¿‡ç¨‹éœ€è¦ä¸‹è½½å¤§é‡ä¾èµ–ï¼Œç¡®ä¿ç½‘ç»œç•…é€š
5. **æƒé™é—®é¢˜**ï¼šå¦‚æžœé‡åˆ°æƒé™é—®é¢˜ï¼Œä½¿ç”¨ `sudo` æ‰§è¡Œå‘½ä»¤

## ðŸ” æ•…éšœæŽ’æŸ¥

å¦‚æžœé‡æ–°éƒ¨ç½²åŽä»æœ‰é—®é¢˜ï¼š

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs [service-name]

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tunlp | grep -E '8080|8848|3306|6379'

# æ£€æŸ¥Dockerèµ„æº
docker system df
docker ps -a

# æ¸…ç†Dockerç¼“å­˜
docker system prune -a --volumes
```

